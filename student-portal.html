<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Attendance Portal</title>
<style>
body { font-family:'Segoe UI',sans-serif; background:#f8fafc; color:#1e293b; margin:0; }
header { background:#1e3a8a; color:white; text-align:center; padding:20px; }
form { max-width:500px; margin:30px auto; background:white; padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
label { font-weight:600; display:block; margin-top:15px; }
input, select { width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:6px; }
button { margin-top:20px; width:100%; background:#1e3a8a; color:white; border:none; padding:12px; border-radius:8px; cursor:pointer; font-weight:600; }
button:hover { background:#3b82f6; }
#info { margin-top:15px; text-align:center; font-weight:600; }
#studentInfo p { margin:5px 0; }
</style>
</head>
<body>

<header>
  <h1>üéì Student Attendance Portal</h1>
  <p>New Sri Raja Driving School</p>
</header>

<form id="attendanceForm" autocomplete="off">
  <label>Phone Number</label>
  <input type="text" id="phone" name="phone" required autocomplete="off" />

  <button type="button" id="verifyBtn">üîç Verify Student</button>

  <div id="studentInfo" style="display:none;">
    <p><strong>Name:</strong> <span id="studentName"></span></p>
    <p><strong>Course:</strong> <span id="studentCourse"></span></p>
    <p><strong>Classes Taken:</strong> <span id="studentTaken"></span></p>
    <p><strong>Remaining:</strong> <span id="studentRemaining"></span></p>
  </div>

  <label id="timingLabel" style="display:none;">Select Timing</label>
  <select id="timing" name="timing" style="display:none;">
    <option value="">-- Select Timing --</option>
  </select>

  <button type="submit" id="markBtn" disabled>Mark Attendance</button>
  <div id="info"></div>
</form>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxnc1kVhvstCb5jE3g-97TobzmTL_B1emC_cyfRlByFRXanTMmZIK22lL0_4qQE-a8x/exec";

const phoneInput = document.getElementById("phone");
const verifyBtn = document.getElementById("verifyBtn");
const markBtn = document.getElementById("markBtn");
const info = document.getElementById("info");
const studentInfoDiv = document.getElementById("studentInfo");
const timingLabel = document.getElementById("timingLabel");
const timingSelect = document.getElementById("timing");

let isVerified = false; // only true after successful Verify

// Clear verification when phone value changes
phoneInput.addEventListener("input", () => {
  if (isVerified) {
    isVerified = false;
    markBtn.disabled = true;
    studentInfoDiv.style.display = "none";
    timingLabel.style.display = "none";
    timingSelect.style.display = "none";
    info.textContent = "";
  }
});

// Prevent Enter key from submitting form when focus is in phone input
phoneInput.addEventListener("keydown", (ev) => {
  if (ev.key === "Enter") {
    ev.preventDefault();
    // Optionally trigger verify automatically:
    // verifyBtn.click();
  }
});

verifyBtn.addEventListener("click", () => {
  const phone = phoneInput.value.trim();
  if (phone === "") {
    info.textContent = "‚ö†Ô∏è Please enter phone number.";
    return;
  }

  info.textContent = "Verifying student...";
  fetch(`${SCRIPT_URL}?phone=${encodeURIComponent(phone)}`)
    .then(res => res.json())
    .then(data => {
      if (data.status === "NOT_REGISTERED") {
        info.textContent = "‚ùå Not a registered student!";
        isVerified = false;
        markBtn.disabled = true;
        studentInfoDiv.style.display = "none";
        timingLabel.style.display = "none";
        timingSelect.style.display = "none";
      } else {
        // Populate UI
        document.getElementById("studentName").textContent = data.name;
        document.getElementById("studentCourse").textContent = data.course;
        document.getElementById("studentTaken").textContent = data.taken;
        document.getElementById("studentRemaining").textContent = data.remaining;
        studentInfoDiv.style.display = "block";
        info.textContent = "";

        // Build timing dropdown (fresh)
        timingSelect.innerHTML = `<option value="">-- Select Timing --</option>`;
        const times = [];
        if (String(data.course).toLowerCase().includes("fast")) {
          for (let h = 6; h <= 18; h++) {
            const ampm = h < 12 ? "AM" : "PM";
            const display = `${h > 12 ? h - 12 : h}:00 ${ampm}`;
            times.push(display);
          }
        } else {
          for (let h = 6; h <= 18; h++) {
            const ampm = h < 12 ? "AM" : "PM";
            times.push(`${h > 12 ? h - 12 : h}:00 ${ampm}`);
            times.push(`${h > 12 ? h - 12 : h}:30 ${ampm}`);
          }
        }
        times.forEach(t => {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          timingSelect.appendChild(opt);
        });

        // mark as verified and enable mark button
        isVerified = true;
        markBtn.disabled = false;

        timingLabel.style.display = "block";
        timingSelect.style.display = "block";
      }
    })
    .catch(() => {
      info.textContent = "‚ö†Ô∏è Error verifying student.";
      isVerified = false;
      markBtn.disabled = true;
    });
});

// Form submit: enforce verification + timing
document.getElementById("attendanceForm").addEventListener("submit", e => {
  e.preventDefault();

  if (!isVerified) {
    info.textContent = "‚ö†Ô∏è Please verify the student first.";
    return;
  }

  const phone = phoneInput.value.trim();
  const timing = timingSelect.value;
  if (!timing) {
    info.textContent = "‚ö†Ô∏è Please select your class timing before submitting.";
    return;
  }

  markBtn.disabled = true; // prevent double submissions
  info.textContent = "Submitting attendance...";

  const formData = new FormData();
  formData.append("phone", phone);
  formData.append("timing", timing);

  fetch(SCRIPT_URL, { method: "POST", body: formData })
    .then(res => res.text())
    .then(text => {
      if (text === "SUCCESS") {
        info.textContent = "‚úÖ Attendance recorded!";
        // reset UI & verification
        isVerified = false;
        markBtn.disabled = true;
        studentInfoDiv.style.display = "none";
        timingLabel.style.display = "none";
        timingSelect.style.display = "none";
        phoneInput.value = "";
      } else if (text === "LIMIT_REACHED") {
        info.textContent = "‚ö†Ô∏è All 20 classes completed!";
      } else if (text === "NOT_REGISTERED") {
        info.textContent = "‚ùå Not registered!";
      } else {
        info.textContent = "‚ùå Unknown error.";
      }
    })
    .catch(() => {
      info.textContent = "‚ö†Ô∏è Error connecting to server.";
    })
    .finally(() => {
      markBtn.disabled = false;
    });
});
</script>

</body>
</html>
