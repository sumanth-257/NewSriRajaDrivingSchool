<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin - Approve Attendance</title>
<style>
  body { font-family:'Segoe UI',sans-serif; background:#f1f5f9; margin:0; padding:0; }
  header { background:#0f172a; color:white; padding:16px; text-align:center; }
  .container { max-width:900px; margin:28px auto; background:white; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  input, button { padding:10px; border-radius:8px; border:1px solid #cbd5e1; }
  button { background:#1e40af; color:white; border:none; cursor:pointer; font-weight:700; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { border:1px solid #e6edf3; padding:10px; text-align:center; }
  th { background:#1e40af; color:white; }
  .small { font-size:13px; color:#334155; }
</style>
</head>
<body>
<header><h2>ðŸ§¾ Admin - Approve Attendance</h2></header>
<div class="container">
  <div style="text-align:center;">
    <input type="password" id="password" placeholder="Enter admin password" />
    <button id="loadBtn">Load Pending</button>
    <p id="loginStatus" class="small"></p>
  </div>

  <div id="pendingArea" style="margin-top:18px;">
    <table id="pendingTable">
      <thead>
        <tr>
          <th>Date</th><th>Phone</th><th>Name</th><th>Course</th><th>Timing</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxfNkbpjmrYj4TpM-XBUxvWJ0xOvIhJCE4mrsz0TQsOZzL_zJ0s0xFrv7PKtHS5TWfb/exec"; 

document.getElementById("loadBtn").addEventListener("click", loadPending);

function loadPending() {
  const pass = document.getElementById("password").value.trim();
  if (!pass) { document.getElementById("loginStatus").textContent = "Enter password."; return; }
  document.getElementById("loginStatus").textContent = "Loading...";
  fetch(`${SCRIPT_URL}?action=pending&password=${encodeURIComponent(pass)}`)
    .then(r => r.json())
    .then(data => {
      if (!data) { document.getElementById("loginStatus").textContent = "No response."; return; }
      if (data.status === "UNAUTHORIZED") {
        document.getElementById("loginStatus").textContent = "âŒ Wrong password.";
        return;
      }
      document.getElementById("loginStatus").textContent = `Loaded ${data.records.length} pending record(s).`;
      populateTable(data.records);
    })
    .catch(err => {
      document.getElementById("loginStatus").textContent = "Error loading pending records.";
      console.error(err);
    });
}

function populateTable(rows) {
  const tbody = document.querySelector("#pendingTable tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    // date is ISO string from server
    const dateText = r.date ? new Date(r.date).toLocaleString() : "";
    tr.innerHTML = `
      <td>${dateText}</td>
      <td>${escapeHtml(r.phone)}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.course)}</td>
      <td>${escapeHtml(r.timing)}</td>
      <td>
        <button onclick="approve('${encodeURIComponent(r.phone)}','${encodeURIComponent(r.date)}', this)">Approve</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Approve function: sends POST action=approve; on success removes row
function approve(encodedPhone, encodedDate, btn) {
  const phone = decodeURIComponent(encodedPhone || "");
  const date = decodeURIComponent(encodedDate || "");
  btn.disabled = true;
  btn.textContent = "Approving...";
  fetch(SCRIPT_URL, {
    method: "POST",
    body: new URLSearchParams({ action: "approve", phone: phone, date: date })
  })
  .then(r => r.text())
  .then(txt => {
    const t = (txt || "").trim();
    if (t === "APPROVED") {
      // remove row from table (btn is inside the cell)
      const row = btn.closest("tr");
      if (row) row.remove();
      alert("âœ… Approved and moved to Attendance.");
      // update status text
      const s = document.getElementById("loginStatus");
      s.textContent = "Approved successfully.";
    } else {
      alert("âš ï¸ Could not approve: " + t);
      btn.disabled = false;
      btn.textContent = "Approve";
    }
  })
  .catch(() => {
    alert("Network error approving.");
    btn.disabled = false;
    btn.textContent = "Approve";
  });
}

// small helper to avoid HTML injection
function escapeHtml(s) {
  if (!s) return "";
  return String(s).replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}
</script>
</body>
</html>
